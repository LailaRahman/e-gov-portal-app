<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      min-height: 100vh;
      padding: 30px 15px;
    }
    .dashboard-card {
      max-width: 900px;
      margin: 0 auto;
      background: #fff;
      padding: 30px 25px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h2, h3 {
      font-weight: 700;
    }
    p {
      font-size: 1.1rem;
    }
    .btn-primary, .btn-secondary {
      font-weight: 600;
      border-radius: 4px;
    }
    table.table {
      margin-top: 20px;
    }
    .alert p {
      margin-bottom: 0.25rem;
    }
  </style>
</head>
<body>

  <div class="dashboard-card">
    <h2 class="mb-3">Welcome, <%= user.name %></h2>
    <p class="mb-4">You are logged in as <strong><%= user.role %></strong>.</p>

    <% if (success && success.length > 0) { %>
      <div class="alert alert-success">
        <% success.forEach(msg => { %>
          <p><%= msg %></p>
        <% }); %>
      </div>
    <% } %>

    <% if (error && error.length > 0) { %>
      <div class="alert alert-danger">
        <% error.forEach(msg => { %>
          <p><%= msg %></p>
        <% }); %>
      </div>
    <% } %>

    <!-- Notifications Section -->
    <h3>Your Notifications</h3>
    <% if (notifications && notifications.length > 0) { %>
      <ul class="list-group mb-4">
        <% notifications.forEach(notification => { %>
          <li class="list-group-item d-flex justify-content-between align-items-center <%= notification.is_read ? '' : 'fw-bold' %>">
            <%= notification.message %>
            <small class="text-muted"><%= new Date(notification.createdAt).toLocaleString() %></small>
          </li>
        <% }) %>
      </ul>
    <% } else { %>
      <p class="text-muted mb-4">No new notifications.</p>
    <% } %>

    <a href="/citizen/apply" class="btn btn-primary mb-4">Apply for New Service</a>

    <h3>Your Applications</h3>

    <div class="table-responsive">
      <table class="table table-bordered table-striped align-middle">
        <thead class="table-light">
          <tr>
            <th scope="col" style="width:5%;">#</th>
            <th scope="col">Service</th>
            <th scope="col">Department</th>
            <th scope="col">Fee</th>
            <th scope="col">Status</th>
            <th scope="col">Payment</th>
            <th scope="col">Submitted On</th>
          </tr>
        </thead>
        <tbody>
          <% if (requests.length === 0) { %>
            <tr>
              <td colspan="7" class="text-center py-4">You have not submitted any service requests yet.</td>
            </tr>
          <% } else { %>
            <% requests.forEach((r, index) => { %>
              <tr>
                <th scope="row"><%= index + 1 %></th>
                <td><%= r.service?.name || 'N/A' %></td>
                <td><%= r.service?.department?.name || 'N/A' %></td>
                <td>
                  $<%= typeof r.payment_amount === 'number' ? r.payment_amount.toFixed(2) : parseFloat(r.payment_amount || 0).toFixed(2) %>
                </td>
                <td>
                  <% if (r.status === 'submitted') { %>
                    <span class="text-primary fw-semibold">Submitted</span>
                  <% } else if (r.status === 'under_review') { %>
                    <span class="text-warning fw-semibold">Under Review</span>
                  <% } else if (r.status === 'approved') { %>
                    <span class="text-success fw-semibold">Approved</span>
                  <% } else if (r.status === 'rejected') { %>
                    <span class="text-danger fw-semibold">Rejected</span>
                  <% } else { %>
                    <%= r.status %>
                  <% } %>
                </td>
                <td>
                  <% if (r.payment_status === 'paid') { %>
                    <span class="badge bg-success">Paid</span>
                  <% } else { %>
                    <a href="/citizen/payment/<%= r.id %>" class="btn btn-sm btn-success">Pay Now</a>
                  <% } %>
                </td>
                <td><%= new Date(r.createdAt).toLocaleDateString() %></td>
              </tr>
            <% }) %>
          <% } %>
        </tbody>
      </table>
    </div>

    <a href="/profile" class="btn btn-secondary mt-3">View / Edit Profile</a>
  </div>

  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
